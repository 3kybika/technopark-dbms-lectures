---
title: Лекция 4
description: |
  Транзакции, триггеры и хранимые процедуры.

   - Транзакции:
     - Зачем нужны транзакции?
     - Обеспечение долговечности. Журнал транзакций;
     - Обеспечение изолированности и атомарности. MVCC;
     - Немного про консистентность;
     - Уровни изолированности транзакций.
   - Триггеры:
     - Использование триггеров для поддержания целостности и бизнес-логики;
     - Примеры триггеров;
     - Недостатки триггеров.
   - Хранимые процедуры и функции:
     - Примеры хранимых процедур.
   - Распределенные транзакции (XA) и персистентные очереди.
---
<div>
    <style>
tr.read {
    background: linear-gradient(
        -45deg,
        transparent 49.9%,
        skyblue 49.9%,
        skyblue 60%,
        transparent 60%
    ), linear-gradient(
        -45deg,
        skyblue 10%,
        transparent 10%
    );
    background-size: 8px 8px;
}

tr.update {
    background-color: #ffb !important;
}

tr.delete {
    background-color: #fbb !important;
}

tr.insert {
    background-color: #bfb !important;
    font-weight: bold;
}

.changed {
    font-weight: bold;
}

.obsolete {
    font-style: italic;
}

.label-l, .label-r {
    position: absolute;
    padding-top: 2px;
    height: 36px;
    font-size: 80%;
    font-weight: bold;
    font-style: normal;
}

.label-l {
    left: 100px;
    width: 99px;
    padding-left: 6px;
}

.label-l:after {
    content: "";
    position: absolute;
    top: 0px;
    left: 98px;
    height: 36px;
    width: 19px;
    border: 18px solid transparent;
    border-right: 0;
}

.update .label-l {
    background-color: #ffb;
}

.delete .label-l {
    background-color: #fbb;
}

.insert .label-l {
    background-color: #bfb;
}

.update .label-l:after {
    border-left-color: #ffb;
}

.delete .label-l:after {
    border-left-color: #fbb;
}

.insert .label-l:after {
    border-left-color: #bfb;
}

.read .label-r {
    background-color: #bbf;
}

.read .label-r:before {
    border-right-color: #bbf;
}

.label-r {
    right: 100px;
    width: 99px;
    padding-left: 6px;
}

.label-r:before {
    content: "";
    position: absolute;
    top: 0px;
    right: 98px;
    height: 36px;
    width: 19px;
    border: 18px solid transparent;
    border-left: 0;
}

.mvcc {
    margin-left: 120px;
    margin-right: 120px;
}

.mvcc table {
     width: 100%;
}


    </style>
</div>
<section class="slide">
    <h2>Транзакции, триггеры и процедуры</h2>
    <ul>
        <li>Транзакции:
            <ul class="compact">
                <li>Обеспечение долговечности. Журнал транзакций;</li>
                <li>Обеспечение изолированности и атомарности. MVCC;</li>
                <li>Уровни изолированности транзакций.</li>
            </ul>
        </li>
        <li>Триггеры:
            <ul class="compact">
                <li>Использование триггеров для поддержания целостности и бизнес-логики;</li>
                <li>Недостатки триггеров.</li>
            </ul>
        </li>
        <li>Хранимые процедуры и функции</li>
        <li>Распределенные транзакции (XA) и персистентные очереди.</li>
    </ul>
</section>

<section class="slide">
    <h2>ACID</h2>
    <img style="position: absolute; right: 50px; bottom: 50px; border: 1px solid black" height="280" src="jim-gray.jpg">
    <p>ACID описывает требования к транзакционной системе, обеспечивающие наиболее надёжную и предсказуемую её работу.
        Требования ACID были в основном сформулированы в конце 70-х годов Джимом Греем.</p>
    <ul>
        <li><b>A</b>tomicity — Атомарность</li>
        <li><b>C</b>onsistency — Согласованность</li>
        <li><b>I</b>solation — Изолированность</li>
        <li><b>D</b>urability — Долговечность</li>
    </ul>
</section>

<section class="slide">
    <h2>Atomicity — Атомарность</h2>
    <img style="position: absolute; right: 50px; bottom: 50px" height="320" src="atomicity.png">
    <p>Атомарность гарантирует, что никакая транзакция не будет зафиксирована в системе частично. Будут либо выполнены
        все её подоперации, либо не выполнено ни одной.</p>
</section>

<section class="slide">
    <h2>Consistency — Согласованность</h2>
    <img style="position: absolute; right: 50px; bottom: 50px" height="320" src="consistency.png">
    <p>Транзакция, достигающая своего нормального завершения и, фиксирующая свои результаты, сохраняет согласованность
        базы данных.</p>
    <p>Другими словами, каждая успешная транзакция по определению фиксирует только допустимые результаты.</p>
</section>

<section class="slide">
    <h2>Isolation — Изолированность</h2>
    <img style="position: absolute; right: 50px; bottom: 50px" height="320" src="isolation.png">
    <p>Во время выполнения транзакции параллельные транзакции не должны оказывать влияние на её результат.</p>
</section>

<section class="slide">
    <h2>Durability — Долговечность</h2>
    <img style="position: absolute; right: 50px; bottom: 50px" height="320" src="durability.png">
    <p>Независимо от проблем на нижних уровнях (к примеру, обесточивание системы или сбои в оборудовании) изменения,
        сделанные успешно завершённой транзакцией, должны остаться сохранёнными после возвращения системы в работу.</p>
</section>

<section class="slide">
    <h2>Пример транзакции</h2>
    <pre><code class="sql">BEGIN;

UPDATE accounts SET balance = balance - 100.00
    WHERE name = 'Alice';

UPDATE accounts SET balance = balance + 100.00
    WHERE name = 'Bob';

COMMIT;</code></pre>
</section>

<section class="slide">
    <h2>Журнал транзакций</h2>
    <p>В простейшем случае журнализация изменений заключается в последовательной записи всех изменений, выполняемых в
        базе данных.</p>
    <p>Записывается следующая информация:</p>
    <ul class="compact">
        <li>порядковый номер, тип и время изменения;</li>
        <li>идентификатор транзакции;</li>
        <li>объект, подвергшийся изменению (номер хранимого файла и номер блока данных в нём, номер строки внутри
            блока);
        </li>
        <li>предыдущее состояние объекта и новое состояние объекта.</li>
    </ul>
    <p>Журнал содержит отметки начала и завершения транзакции, и отметки принятия контрольной точки.</p>
</section>

<section class="slide">
    <h2>Журнал транзакций</h2>
    <img style="position: absolute; right: 50px; bottom: 50px" height="280" src="hdd.png">
    <p>Общий алгоритм:</p>
    <ul class="compact">
        <li>измения пишутся в журнал транзакций (состояние до и после) и изменяются страницы БД в памяти;</li>
        <li>в журнал транзакций сбрасывается маркер успешного завершения транзакции;</li>
        <li>журнал транзакций сбрасывается на диск;</li>
        <li>данные страниц БД пишутся на диск;</li>
        <li>данные страниц БД сбрасываются на диск.</li>
    </ul>
    <div class="important next" style="width: 550px">
        <p>Минимальное время транзакции не меньше времени сброса данных на диск.</p>
    </div>
    <footer class="footer">https://habrahabr.ru/post/181584/</footer>
</section>

<section class="slide">
    <h2>Приблизительные значения IOPS</h2>
    <table class="classic">
        <thead>
        <tr>
            <th>Тип</th>
            <th>Устройство</th>
            <th>IOPS</th>
            <th>Интерфейс</th>
        </tr>
        </thead>
        <tbody>
        <tr>
            <td>HDD</td>
            <td>7,200 об/мин SATA-диски</td>
            <td>~75-100</td>
            <td>SATA 3 Гбит/с</td>
        </tr>
        <tr>
            <td>HDD</td>
            <td>10,000 об/мин SATA-диски</td>
            <td>~125-150</td>
            <td>SATA 3 Гбит/с</td>
        </tr>
        <tr>
            <td>HDD</td>
            <td>10,000 об/мин SAS-диски</td>
            <td>~140</td>
            <td>SAS</td>
        </tr>
        <tr>
            <td>HDD</td>
            <td>15,000 об/мин SAS-диски</td>
            <td>~175-210</td>
            <td>SAS</td>
        </tr>
        <tr>
            <td>SSD</td>
            <td>Intel X25-M G2 MLC</td>
            <td>~8 600</td>
            <td>SATA 3 Гбит/с</td>
        </tr>
        <tr>
            <td>SSD</td>
            <td>OCZ Vertex 3</td>
            <td>~60 000 (4K)</td>
            <td>SATA 6 Гбит/с</td>
        </tr>
        <tr>
            <td>SSD</td>
            <td>OCZ Vertex 3 MAX IOPS</td>
            <td>~75 000 (4K)</td>
            <td>SATA 6 Гбит/с</td>
        </tr>
        <tr>
            <td>SSD</td>
            <td>OCZ Vertex 4</td>
            <td>~120 000 IOPS (4K)</td>
            <td>SATA 6 Гбит/с</td>
        </tr>
        <tr>
            <td>SSD</td>
            <td>OCZ RevoDrive 3 X2</td>
            <td>~200 000 IOPS (4K)</td>
            <td>PCIe</td>
        </tr>
        <tr>
            <td>SSD</td>
            <td>OCZ Z-Drive R4 CloudServ</td>
            <td>~500 000 IOPS</td>
            <td>PCIe</td>
        </tr>
        </tbody>
    </table>
    <footer class="footer">https://ru.wikipedia.org/wiki/IOPS</footer>
</section>

<section class="slide">
    <h2>Групповой коммит</h2>
    <div style="text-align: center">
        <img src="group-commit.svg" style="height: 430px"/>
    </div>
</section>

<section class="slide">
    <h2>Журнал транзакций. Бонус</h2>
    <img style="position: absolute; right: 50px; bottom: 50px" height="360" src="bonus.png">
    <p>На базе журнала транзакций так же реализуется ряд дополнительных возможностей:</p>
    <ul>
        <li>Point in time recovery;</li>
        <li>Репликация.</li>
    </ul>
</section>

<section class="slide">
    <h2>Изолированность. MVCC</h2>
    <dl>
        <dt>MVCC</dt>
        <dd>MultiVersion Concurrency Control</dd>
    </dl>
    <ul>
        <li>Разные пользователи могут одновременно работать с одними и теми же данными;</li>
        <li>Каждый пользователь видит свой изолированный срез данных;</li>
        <li>Изменения, вносимые пользователем, никому не видны до завершения транзации.</li>
    </ul>
    <footer class="footer">
        <ul>
            <li>https://www.slideshare.net/robertsosinski/mvcc-robert-sosinski</li>
            <li>http://momjian.us/main/writings/pgsql/mvcc.pdf</li>
        </ul>
    </footer>
</section>

<section class="slide">
    <h2>UPDATE IN PLACE 1: TABLE</h2>
    <div class="mvcc">
        <table class="classic bordered">
            <thead>
            <tr>
                <th>id</th>
                <th>name</th>
                <th>notes</th>
            </tr>
            </thead>
            <tbody>
            <tr>
                <td>1</td>
                <td>Alice</td>
                <td>Great at programming</td>
            </tr>
            <tr>
                <td>2</td>
                <td>Bob</td>
                <td>Always talking to alice</td>
            </tr>
            <tr>
                <td>3</td>
                <td>Eve</td>
                <td>Listens to everyone's conversations</td>
            </tr>
            </tbody>
        </table>
    </div>
</section>

<section class="slide">
    <h2>UPDATE IN PLACE 2: SCAN</h2>
    <div class="mvcc">
        <table class="classic bordered">
            <thead>
            <tr>
                <th>id</th>
                <th>name</th>
                <th>notes</th>
            </tr>
            </thead>
            <tbody>
            <tr class="read">
                <td>1</td>
                <td>Alice</td>
                <td>
                    <div class="label-r">read</div>
                    Great at programming
                </td>
            </tr>
            <tr class="read">
                <td>2</td>
                <td>Bob</td>
                <td>Always talking to alice</td>
            </tr>
            <tr class="read">
                <td>3</td>
                <td>Eve</td>
                <td>Listens to everyone's conversations</td>
            </tr>
            </tbody>
        </table>
    </div>
</section>

<section class="slide">
    <h2>UPDATE IN PLACE 3: UPDATE</h2>
    <div class="mvcc">
        <table class="classic bordered">
            <thead>
            <tr>
                <th>id</th>
                <th>name</th>
                <th>notes</th>
            </tr>
            </thead>
            <tbody>
            <tr>
                <td>1</td>
                <td>Alice</td>
                <td>Great at programming</td>
            </tr>
            <tr class="update">
                <td>
                    <div class="label-l">~ update</div>
                    2
                </td>
                <td>Bob</td>
                <td>Always talking to alice</td>
            </tr>
            <tr>
                <td>3</td>
                <td>Eve</td>
                <td>Listens to everyone's conversations</td>
            </tr>
            </tbody>
        </table>
    </div>
</section>

<section class="slide">
    <h2>UPDATE IN PLACE 4: UPDATED</h2>
    <div class="mvcc">
        <table class="classic bordered">
            <thead>
            <tr>
                <th>id</th>
                <th>name</th>
                <th>notes</th>
            </tr>
            </thead>
            <tbody>
            <tr>
                <td>1</td>
                <td>Alice</td>
                <td>Great at programming</td>
            </tr>
            <tr class="update">
                <td>
                    <div class="label-l">~ update</div>
                    2
                </td>
                <td>Bob</td>
                <td class="changed">Working very hard</td>
            </tr>
            <tr>
                <td>3</td>
                <td>Eve</td>
                <td>Listens to everyone's conversations</td>
            </tr>
            </tbody>
        </table>
    </div>
</section>

<section class="slide">
    <h2>UPDATE IN PLACE 5: INSERT</h2>
    <div class="mvcc">
        <table class="classic bordered">
            <thead>
            <tr>
                <th>id</th>
                <th>name</th>
                <th>notes</th>
            </tr>
            </thead>
            <tbody>
            <tr>
                <td>1</td>
                <td>Alice</td>
                <td>Great at programming</td>
            </tr>
            <tr class="update">
                <td>2</td>
                <td>Bob</td>
                <td class="changed">Working very hard</td>
            </tr>
            <tr>
                <td>3</td>
                <td>Eve</td>
                <td>Listens to everyone's conversations</td>
            </tr>
            <tr class="insert">
                <td>
                    <div class="label-l">+ insert</div>
                    4
                </td>
                <td>Dave</td>
                <td>Very promising new-hire</td>
            </tr>
            </tbody>
        </table>
    </div>
</section>

<section class="slide">
    <h2>UPDATE IN PLACE 6: DELETE</h2>
    <div class="mvcc">
        <table class="classic bordered">
            <thead>
            <tr>
                <th>id</th>
                <th>name</th>
                <th>notes</th>
            </tr>
            </thead>
            <tbody>
            <tr>
                <td>1</td>
                <td>Alice</td>
                <td>Great at programming</td>
            </tr>
            <tr class="update">
                <td>2</td>
                <td>Bob</td>
                <td class="changed">Working very hard</td>
            </tr>
            <tr class="delete">
                <td>
                    <div class="label-l">- delete</div>
                    3
                </td>
                <td>Eve</td>
                <td>Listens to everyone's conversations</td>
            </tr>
            <tr class="insert">
                <td>4</td>
                <td>Dave</td>
                <td>Very promising new-hire</td>
            </tr>
            </tbody>
        </table>
    </div>
</section>

<section class="slide">
    <h2>UPDATE IN PLACE 7</h2>
    <div class="mvcc">
        <table class="classic bordered">
            <thead>
            <tr>
                <th>id</th>
                <th>name</th>
                <th>notes</th>
            </tr>
            </thead>
            <tbody>
            <tr>
                <td>1</td>
                <td>Alice</td>
                <td>Great at programming</td>
            </tr>
            <tr class="update">
                <td>2</td>
                <td>Bob</td>
                <td class="changed">Working very hard</td>
            </tr>
            <tr class="insert">
                <td>4</td>
                <td>Dave</td>
                <td>Very promising new-hire</td>
            </tr>
            </tbody>
        </table>
    </div>
</section>

<section class="slide">
    <h2>UPDATE IN PLACE 8: REALITY</h2>
    <div class="mvcc">
        <table class="classic bordered">
            <thead>
            <tr>
                <th>id</th>
                <th>name</th>
                <th>notes</th>
            </tr>
            </thead>
            <tbody>
            <tr class="read">
                <td>1</td>
                <td>Alice</td>
                <td>
                    <div class="label-r">read</div>
                    Great at programming
                </td>
            </tr>
            <tr class="read update">
                <td>
                    <div class="label-l">+ update</div>
                    2
                </td>
                <td>Bob</td>
                <td class="read changed">Working very hard</td>
            </tr>
            <tr class="read delete">
                <td>
                    <div class="label-l">- delete</div>
                    3
                </td>
                <td>Eve</td>
                <td>Listens to everyone's conversations</td>
            </tr>
            <tr class="insert">
                <td>
                    <div class="label-l">+ insert</div>
                    4
                </td>
                <td>Dave</td>
                <td>Very promising new-hire</td>
            </tr>
            </tbody>
        </table>
    </div>
</section>

<section class="slide">
    <h2>MVCC 1: TABLE</h2>
    <div class="mvcc">
        <table class="classic bordered">
            <thead>
            <tr>
                <th>
                    <div class="label-r">TXID: 103</div>
                    xmin
                </th>
                <th>xmax</th>
                <th>id</th>
                <th>name</th>
                <th>notes</th>
            </tr>
            </thead>
            <tbody>
            <tr>
                <td>100</td>
                <td>0</td>
                <td>1</td>
                <td>Alice</td>
                <td>Great at programming</td>
            </tr>
            <tr>
                <td>101</td>
                <td>0</td>
                <td>2</td>
                <td>Bob</td>
                <td>Always talk to alice</td>
            </tr>
            <tr>
                <td>102</td>
                <td>0</td>
                <td>3</td>
                <td>Eve</td>
                <td>Listens to everyone's conversations</td>
            </tr>
            </tbody>
        </table>
    </div>
</section>

<section class="slide">
    <h2>MVCC 2: UPDATE</h2>
    <div class="mvcc">
        <table class="classic bordered">
            <thead>
            <tr>
                <th>
                    <div class="label-r">TXID: 103</div>
                    xmin
                </th>
                <th>xmax</th>
                <th>id</th>
                <th>name</th>
                <th>notes</th>
            </tr>
            </thead>
            <tbody>
            <tr>
                <td>100</td>
                <td>0</td>
                <td>1</td>
                <td>Alice</td>
                <td>Great at programming</td>
            </tr>
            <tr class="update">
                <td>
                    <div class="label-l">- update</div>
                    101
                </td>
                <td>0</td>
                <td>2</td>
                <td>Bob</td>
                <td>Always talk to alice</td>
            </tr>
            <tr>
                <td>102</td>
                <td>0</td>
                <td>3</td>
                <td>Eve</td>
                <td>Listens to everyone's conversations</td>
            </tr>
            </tbody>
        </table>
    </div>
</section>

<section class="slide">
    <h2>MVCC 3: UPDATE IN PROGRESS</h2>
    <div class="mvcc">
        <table class="classic bordered">
            <thead>
            <tr>
                <th>
                    <div class="label-r">TXID: 103</div>
                    xmin
                </th>
                <th>xmax</th>
                <th>id</th>
                <th>name</th>
                <th>notes</th>
            </tr>
            </thead>
            <tbody>
            <tr>
                <td>100</td>
                <td>0</td>
                <td>1</td>
                <td>Alice</td>
                <td>Great at programming</td>
            </tr>
            <tr class="update obsolete">
                <td>
                    <div class="label-l">- update</div>
                    101
                </td>
                <td class="changed">103</td>
                <td>2</td>
                <td>Bob</td>
                <td>Always talk to alice</td>
            </tr>
            <tr>
                <td>102</td>
                <td>0</td>
                <td>3</td>
                <td>Eve</td>
                <td>Listens to everyone's conversations</td>
            </tr>
            </tbody>
        </table>
    </div>
</section>

<section class="slide">
    <h2>MVCC 4: UPDATE IN PROGRESS</h2>
    <div class="mvcc">
        <table class="classic bordered">
            <thead>
            <tr>
                <th>
                    <div class="label-r">TXID: 103</div>
                    xmin
                </th>
                <th>xmax</th>
                <th>id</th>
                <th>name</th>
                <th>notes</th>
            </tr>
            </thead>
            <tbody>
            <tr>
                <td>100</td>
                <td>0</td>
                <td>1</td>
                <td>Alice</td>
                <td>Great at programming</td>
            </tr>
            <tr class="update obsolete">
                <td>
                    <div class="label-l">- update</div>
                    101
                </td>
                <td class="changed">103</td>
                <td>2</td>
                <td>Bob</td>
                <td>Always talk to alice</td>
            </tr>
            <tr>
                <td>102</td>
                <td>0</td>
                <td>3</td>
                <td>Eve</td>
                <td>Listens to everyone's conversations</td>
            </tr>
            <tr class="update changed">
                <td>
                    <div class="label-l">+ update</div>
                    103
                </td>
                <td>0</td>
                <td>2</td>
                <td>Bob</td>
                <td>Working very hard</td>
            </tr>
            </tbody>
        </table>
    </div>
</section>

<section class="slide">
    <h2>MVCC 5: UPDATED</h2>
    <div class="mvcc">
        <table class="classic bordered">
            <thead>
            <tr>
                <th>
                    <div class="label-r">TXID: 104</div>
                    xmin
                </th>
                <th>xmax</th>
                <th>id</th>
                <th>name</th>
                <th>notes</th>
            </tr>
            </thead>
            <tbody>
            <tr>
                <td>100</td>
                <td>0</td>
                <td>1</td>
                <td>Alice</td>
                <td>Great at programming</td>
            </tr>
            <tr class="update obsolete">
                <td>101</td>
                <td class="changed">103</td>
                <td>2</td>
                <td>Bob</td>
                <td>Always talk to alice</td>
            </tr>
            <tr>
                <td>102</td>
                <td>0</td>
                <td>3</td>
                <td>Eve</td>
                <td>Listens to everyone's conversations</td>
            </tr>
            <tr class="update changed">
                <td>103</td>
                <td>0</td>
                <td>2</td>
                <td>Bob</td>
                <td>Working very hard</td>
            </tr>
            </tbody>
        </table>
    </div>
</section>

<section class="slide">
    <h2>MVCC 6: INSERT</h2>
    <div class="mvcc">
        <table class="classic bordered">
            <thead>
            <tr>
                <th>
                    <div class="label-r">TXID: 104</div>
                    xmin
                </th>
                <th>xmax</th>
                <th>id</th>
                <th>name</th>
                <th>notes</th>
            </tr>
            </thead>
            <tbody>
            <tr>
                <td>100</td>
                <td>0</td>
                <td>1</td>
                <td>Alice</td>
                <td>Great at programming</td>
            </tr>
            <tr class="update obsolete">
                <td>101</td>
                <td class="changed">103</td>
                <td>2</td>
                <td>Bob</td>
                <td>Always talk to alice</td>
            </tr>
            <tr>
                <td>102</td>
                <td>0</td>
                <td>3</td>
                <td>Eve</td>
                <td>Listens to everyone's conversations</td>
            </tr>
            <tr class="update changed">
                <td>103</td>
                <td>0</td>
                <td>2</td>
                <td>Bob</td>
                <td>Working very hard</td>
            </tr>
            <tr class="insert">
                <td>
                    <div class="label-l">+ insert</div>
                    104
                </td>
                <td>0</td>
                <td>4</td>
                <td>Dave</td>
                <td>Very promising new-hire</td>
            </tr>
            </tbody>
        </table>
    </div>
</section>

<section class="slide">
    <h2>MVCC 7: INSERTED</h2>
    <div class="mvcc">
        <table class="classic bordered">
            <thead>
            <tr>
                <th>
                    <div class="label-r">TXID: 105</div>
                    xmin
                </th>
                <th>xmax</th>
                <th>id</th>
                <th>name</th>
                <th>notes</th>
            </tr>
            </thead>
            <tbody>
            <tr>
                <td>100</td>
                <td>0</td>
                <td>1</td>
                <td>Alice</td>
                <td>Great at programming</td>
            </tr>
            <tr class="update obsolete">
                <td>101</td>
                <td class="changed">103</td>
                <td>2</td>
                <td>Bob</td>
                <td>Always talk to alice</td>
            </tr>
            <tr>
                <td>102</td>
                <td>0</td>
                <td>3</td>
                <td>Eve</td>
                <td>Listens to everyone's conversations</td>
            </tr>
            <tr class="update changed">
                <td>103</td>
                <td>0</td>
                <td>2</td>
                <td>Bob</td>
                <td>Working very hard</td>
            </tr>
            <tr class="insert">
                <td>104</td>
                <td>0</td>
                <td>4</td>
                <td>Dave</td>
                <td>Very promising new-hire</td>
            </tr>
            </tbody>
        </table>
    </div>
</section>

<section class="slide">
    <h2>MVCC 8: DELETE</h2>
    <div class="mvcc">
        <table class="classic bordered">
            <thead>
            <tr>
                <th>
                    <div class="label-r">TXID: 105</div>
                    xmin
                </th>
                <th>xmax</th>
                <th>id</th>
                <th>name</th>
                <th>notes</th>
            </tr>
            </thead>
            <tbody>
            <tr>
                <td>100</td>
                <td>0</td>
                <td>1</td>
                <td>Alice</td>
                <td>Great at programming</td>
            </tr>
            <tr class="update obsolete">
                <td>101</td>
                <td class="changed">103</td>
                <td>2</td>
                <td>Bob</td>
                <td>Always talk to alice</td>
            </tr>
            <tr class="delete obsolete">
                <td>
                    <div class="label-l">- delete</div>
                    102
                </td>
                <td>105</td>
                <td>3</td>
                <td>Eve</td>
                <td>Listens to everyone's conversations</td>
            </tr>
            <tr class="update changed">
                <td>103</td>
                <td>0</td>
                <td>2</td>
                <td>Bob</td>
                <td>Working very hard</td>
            </tr>
            <tr class="insert">
                <td>104</td>
                <td>0</td>
                <td>4</td>
                <td>Dave</td>
                <td>Very promising new-hire</td>
            </tr>
            </tbody>
        </table>
    </div>
</section>

<section class="slide">
    <h2>MVCC 9: DELETED</h2>
    <div class="mvcc">
        <table class="classic bordered">
            <thead>
            <tr>
                <th>
                    <div class="label-r">TXID: 106</div>
                    xmin
                </th>
                <th>xmax</th>
                <th>id</th>
                <th>name</th>
                <th>notes</th>
            </tr>
            </thead>
            <tbody>
            <tr>
                <td>100</td>
                <td>0</td>
                <td>1</td>
                <td>Alice</td>
                <td>Great at programming</td>
            </tr>
            <tr class="update obsolete">
                <td>101</td>
                <td class="changed">103</td>
                <td>2</td>
                <td>Bob</td>
                <td>Always talk to alice</td>
            </tr>
            <tr class="delete obsolete">
                <td>102</td>
                <td>105</td>
                <td>3</td>
                <td>Eve</td>
                <td>Listens to everyone's conversations</td>
            </tr>
            <tr class="update changed">
                <td>103</td>
                <td>0</td>
                <td>2</td>
                <td>Bob</td>
                <td>Working very hard</td>
            </tr>
            <tr class="insert">
                <td>104</td>
                <td>0</td>
                <td>4</td>
                <td>Dave</td>
                <td>Very promising new-hire</td>
            </tr>
            </tbody>
        </table>
    </div>
</section>

<section class="slide">
    <h2>Блокировки</h2>
    <div style="display: table; width: 100%; font-size: 60%">
        <div style="display: table-cell; width: 50%; padding: 10px">
            <pre><code class="sql">test=# BEGIN TRANSACTION
test-# ISOLATION LEVEL REPEATABLE READ;
BEGIN
test=# SELECT balance
test-# FROM accounts WHERE name = 'Alice';
balance
---------
400
(1 row)

test=# UPDATE accounts
test-# SET balance = balance + 100
test-# WHERE name = 'Alice';
UPDATE 1



test=# COMMIT;
COMMIT
            </code></pre>
        </div>
        <div style="display: table-cell; padding: 10px">
            <pre><code class="sql">test=# BEGIN TRANSACTION
test-# ISOLATION LEVEL REPEATABLE READ;
BEGIN
test=# SELECT balance
test-# FROM accounts WHERE name = 'Alice';
balance
---------
400
(1 row)





test=# UPDATE accounts
test-# SET balance = balance + 100
test-# WHERE name = 'Alice';


ERROR:  could not serialize access
        due to concurrent update
            </code></pre>
        </div>
    </div>
</section>

<section class="slide">
    <h2>Блокировки</h2>
    <div style="display: table; width: 100%; font-size: 60%">
        <div style="display: table-cell; width: 50%; padding: 10px">
            <pre><code class="sql">test=# BEGIN TRANSACTION
test-# ISOLATION LEVEL REPEATABLE READ;
BEGIN
test=# SELECT balance
test-# FROM accounts WHERE name = 'Alice';
balance
---------
500
(1 row)

test=# UPDATE accounts
test-# SET balance = balance + 100
test-# WHERE name = 'Alice';
UPDATE 1



test=# ROLLBACK;
ROLLBACK
            </code></pre>
        </div>
        <div style="display: table-cell; padding: 10px">
            <pre><code class="sql">test=# BEGIN TRANSACTION
test-# ISOLATION LEVEL REPEATABLE READ;
BEGIN
test=# SELECT balance
test-# FROM accounts WHERE name = 'Alice';
balance
---------
500
(1 row)





test=# UPDATE accounts
test-# SET balance = balance + 100
test-# WHERE name = 'Alice';


UPDATE 1
test=# COMMIT;
COMMIT
            </code></pre>
        </div>
    </div>
</section>

<section class="slide">
    <h2>Уровни изолированности транзакций</h2>
    <ul class="compact">
        <li>Read uncommitted - чтение незафиксированных данных</li>
        <li>Read committed (по-умолчанию) - чтение фиксированных данных</li>
        <li>Repeatable read - повторяемость чтения</li>
        <li>Serializable - упорядочиваемость</li>
    </ul>
    <table class="classic bordered" style="font-size: 80%">
        <thead>
        <th>Уровень изоляции</th>
        <th>Потерянное обновление</th>
        <th>«Грязное» чтение</th>
        <th>Неповторяющееся чтение</th>
        <th>Фантомное чтение</th>
        </thead>
        <tbody>
        <tr>
            <td>Read&nbsp;uncommited</td>
            <td>+</td>
            <td>-</td>
            <td>-</td>
            <td>-</td>
        </tr>
        <tr>
            <td>Read&nbsp;commited</td>
            <td>+</td>
            <td>+</td>
            <td>-</td>
            <td>-</td>
        </tr>
        <tr>
            <td>Repeatable&nbsp;read</td>
            <td>+</td>
            <td>+</td>
            <td>+</td>
            <td>-</td>
        </tr>
        <tr>
            <td>Serializable</td>
            <td>+</td>
            <td>+</td>
            <td>+</td>
            <td>+</td>
        </tr>
        </tbody>
    </table>
    <footer class="footer">https://technet.microsoft.com/en-us/library/cc546518.aspx</footer>
</section>

<section class="slide">
    <h2>Потерянное обновление (Lost Update)</h2>
    <p>Потерянное обновление происходит в случае перезатирания изменений другой транзакцией до заврешнения транзакции,
        сделавшей изменения.</p>
    <table class="classic bordered">
        <thead>
        <th>Транзакция 1</th>
        <th>Транзакция 2</th>
        </thead>
        <tbody style="font-size: 70%">
        <tr>
            <td>
                <pre><code class="sql">UPDATE tbl1 SET f2=f2+20 WHERE f1=1;</code></pre>
            </td>
            <td>&nbsp;</td>
        </tr>
        <tr>
            <td>&nbsp;</td>
            <td>
                <pre><code class="sql">UPDATE tbl1 SET f2=f2+25 WHERE f1=1;</code></pre>
            </td>
        </tr>
        </tbody>
    </table>
</section>

<section class="slide">
    <h2>«Грязное» чтение (Dirty Read)</h2>
    <p>Чтение данных, добавленных или изменённых еще не завершенной транзакцией.</p>
    <table class="classic bordered">
        <thead>
        <th>Транзакция 1</th>
        <th>Транзакция 2</th>
        </thead>
        <tbody style="font-size: 70%">
        <tr>
            <td><pre><code class="sql">SELECT f2 FROM tbl1 WHERE f1=1;
f2
---------
100
(1 row)</code></pre>
            </td>
            <td>&nbsp;</td>
        </tr>
        <tr>
            <td>
                <pre><code class="sql">UPDATE tbl1 SET f2=200 WHERE f1=1;</code></pre>
            </td>
            <td>&nbsp;</td>
        </tr>
        <tr>
            <td>&nbsp;</td>
            <td><pre><code class="sql">SELECT f2 FROM tbl1 WHERE f1=1;
f2
---------
200
(1 row)</code></pre>
            </td>
        </tr>
        <tr>
            <td>
                <pre><code class="sql">ROLLBACK;</code></pre>
            </td>
            <td>&nbsp;</td>
        </tr>
        </tbody>
    </table>
</section>

<section class="slide">
    <h2>Неповторяющееся чтение (Non-Repeatable Read)</h2>
    <p>При повторном чтении в рамках одной транзакции ранее прочитанные данные оказываются изменёнными.</p>
    <table class="classic bordered">
        <thead>
        <th>Транзакция 1</th>
        <th>Транзакция 2</th>
        </thead>
        <tbody style="font-size: 70%">
        <tr>
            <td>&nbsp;</td>
            <td>
                <pre><code class="sql">SELECT f2 FROM tbl1 WHERE f1=1;</code></pre>
            </td>
        </tr>
        <tr>
            <td>
                <pre><code class="sql">UPDATE tbl1 SET f2=f2+1 WHERE f1=1;</code></pre>
            </td>
            <td>&nbsp;</td>
        </tr>
        <tr>
            <td>
                <pre><code class="sql">COMMIT;</code></pre>
            </td>
            <td>&nbsp;</td>
        </tr>
        <tr>
            <td>&nbsp;</td>
            <td>
                <pre><code class="sql">SELECT f2 FROM tbl1 WHERE f1=1;</code></pre>
            </td>
        </tr>
        </tbody>
    </table>
</section>

<section class="slide">
    <h2>Чтение "фантомов" (Phantom Reads)</h2>
    <p>Ситуация, когда при повторном чтении в рамках одной транзакции одна и та же выборка дает разные множества
        строк.</p>
    <p>От неповторяющегося чтения оно отличается тем, что результат повторного обращения к данным изменился не из-за
        изменения/удаления самих этих данных, а из-за появления новых (фантомных) данных.</p>
    <table class="classic bordered">
        <thead>
        <th>Транзакция 1</th>
        <th>Транзакция 2</th>
        </thead>
        <tbody style="font-size: 70%">
        <tr>
            <td>&nbsp;</td>
            <td>
                <pre><code class="sql">SELECT SUM(f2) FROM tbl1;</code></pre>
            </td>
        </tr>
        <tr>
            <td>
                <pre><code class="sql">INSERT INTO tbl1 (f1,f2) VALUES (15,20);</code></pre>
            </td>
            <td>&nbsp;</td>
        </tr>
        <tr>
            <td>
                <pre><code class="sql">COMMIT;</code></pre>
            </td>
            <td>&nbsp;</td>
        </tr>
        <tr>
            <td>&nbsp;</td>
            <td>
                <pre><code class="sql">SELECT SUM(f2) FROM tbl1;</code></pre>
            </td>
        </tr>
        </tbody>
    </table>
</section>

<section class="slide">
    <h2>Хранимые процедуры</h2>
    <pre style="font-size: 65%"><code class="sql">CREATE [ OR REPLACE ] FUNCTION
    name ( [ [ argmode ] [ argname ] argtype [ { DEFAULT | = } default_expr ] [, ...] ] )
    [ RETURNS rettype
      | RETURNS TABLE ( column_name column_type [, ...] ) ]
  { LANGUAGE lang_name
    | TRANSFORM { FOR TYPE type_name } [, ... ]
    | WINDOW
    | IMMUTABLE | STABLE | VOLATILE | [ NOT ] LEAKPROOF
    | CALLED ON NULL INPUT | RETURNS NULL ON NULL INPUT | STRICT
    | [ EXTERNAL ] SECURITY INVOKER | [ EXTERNAL ] SECURITY DEFINER
    | PARALLEL { UNSAFE | RESTRICTED | SAFE }
    | COST execution_cost
    | ROWS result_rows
    | SET configuration_parameter { TO value | = value | FROM CURRENT }
    | AS 'definition'
    | AS 'obj_file', 'link_symbol'
  } ...
    [ WITH ( attribute [, ...] ) ]
</code></pre>
    <footer class="footer">https://www.postgresql.org/docs/9.6/static/sql-createfunction.html</footer>
</section>

<section class="slide">
    <h2>Хранимые процедуры (+)</h2>
    <ul>
        <li>Разделение логики с другими приложениями. Хранимые процедуры инкапсулируют функциональность; это
            обеспечивает связность доступа к данным и управления ими между различными приложениями.
        </li>
        <li>Изоляция пользователей от таблиц базы данных. Это позволяет давать доступ к хранимым процедурам, но не к
            самим данным таблиц.
        </li>
        <li>Обеспечивает механизм защиты.</li>
        <li>Улучшение выполнения как следствие сокращения сетевого трафика. С помощью хранимых процедур множество
            запросов могут быть объединены.
        </li>
    </ul>
</section>

<section class="slide">
    <h2>Хранимые процедуры (-)</h2>
    <ul>
        <li>Повышение нагрузки на сервер баз данных в связи с тем, что большая часть работы выполняется на серверной
            части, а меньшая - на клиентской.
        </li>
        <li>Дублирование логики своего приложения в двух местах: серверный код и код для хранимых процедур, тем самым
            усложняя процесс манипулирования данными.
        </li>
        <li>Миграция с одной СУБД на другую (DB2, SQL Server и др.) может привести к проблемам.</li>
    </ul>
</section>

<section class="slide">
    <h2>Хранимые процедуры: пример</h2>
    <pre style="font-size: 80%"><code class="sql">DROP FUNCTION IF EXISTS add(integer, integer);

CREATE FUNCTION add(integer, integer) RETURNS integer
    AS 'select $1 + $2;'
    LANGUAGE SQL
    IMMUTABLE
    RETURNS NULL ON NULL INPUT;

CREATE OR REPLACE FUNCTION inc(i integer) RETURNS integer AS $$
        BEGIN
                RETURN i + 1;
        END;
$$ LANGUAGE plpgsql;

SELECT inc(42), add(2, 3);
</code></pre>
</section>

<section class="slide">
    <h2>PL/pgSQL: IF</h2>
    <pre style="font-size: 80%"><code class="sql">IF boolean-expression THEN
    statements
[ ELSIF boolean-expression THEN
    statements
    ...]]
[ ELSE
    statements ]
END IF;
</code></pre>
</section>

<section class="slide">
    <h2>PL/pgSQL: CASE</h2>
    <pre style="font-size: 80%"><code class="sql">CASE search-expression
    WHEN expression [, expression [ ... ]] THEN
      statements
  [ WHEN expression [, expression [ ... ]] THEN
      statements
    ... ]
  [ ELSE
      statements ]
END CASE;

CASE
    WHEN boolean-expression THEN
      statements
  [ WHEN boolean-expression THEN
      statements
    ... ]
  [ ELSE
      statements ]
END CASE;
</code></pre>
</section>

<section class="slide">
    <h2>Хранимые процедуры: LOOP</h2>
    <pre style="font-size: 80%"><code class="sql">[begin_label:] LOOP
	statement_list
END LOOP [end_label]
 
CREATE PROCEDURE doiterate(p1 INT)
BEGIN
	label1: LOOP
		SET p1 = p1 + 1;
		IF p1 < 10 THEN
			ITERATE label1;
		END IF;
		LEAVE label1;
	END LOOP label1;
	SET @x = p1;
END;
</code></pre>
</section>

<section class="slide">
    <h2>Хранимые процедуры: REPEAT, WHILE</h2>
    <pre style="font-size: 80%"><code class="sql">[begin_label:] REPEAT
	statement_list
UNTIL search_condition
END REPEAT [end_label]

[begin_label:] WHILE search_condition DO
	statement_list
END WHILE [end_label]

CREATE PROCEDURE dowhile()
BEGIN
	DECLARE v1 INT DEFAULT 5;
		WHILE v1 > 0 DO
		...
		SET v1 = v1 - 1;
	END WHILE;
END;
</code></pre>
</section>

<section class="slide">
    <h2>Хранимые процедуры: HANDLER</h2>
    <pre style="font-size: 80%"><code class="sql">DECLARE handler_action HANDLER
	FOR condition_value [, condition_value] ...
	statement

handler_action:
	  CONTINUE
	| EXIT
	| UNDO

condition_value:
	  mysql_error_code
	| SQLSTATE [VALUE] sqlstate_value
	| condition_name
	| SQLWARNING
	| NOT FOUND
	| SQLEXCEPTION
</code></pre>
</section>

<section class="slide">
    <h2>Хранимые процедуры: курсоры</h2>
    <pre style="font-size: 80%"><code class="sql">DECLARE cursor-name CURSOR FOR SELECT ...;
OPEN cursor-name;                                
FETCH cursor-name INTO variable [, variable];   
CLOSE cursor-name; 

DECLARE vBankId INTEGER;
DECLARE vBankName VARCHAR(50);
DECLARE vAddress VARCHAR(50);
DECLARE done INTEGER DEFAULT 0;
DECLARE BankCursor CURSOR FOR
	SELECT `bank`.`BankId`, `bank`.`BankName`, `bank`.`Address`
	FROM `bank`; 
DECLARE CONTINUE HANDLER FOR SQLSTATE '02000' SET done=1;
OPEN BankCursor;
WHILE done = 0 DO 
	FETCH BankCursor INTO vBankId,vBankName,vAddress;
END WHILE;
CLOSE BankCursor; 
</code></pre>
</section>

<section class="slide">
    <h2>Хранимые процедуры: EXECUTE</h2>
    <pre style="font-size: 80%"><code class="sql">EXECUTE stmt_name   [USING @var_name [, @var_name] ...]

DELIMITER $$
DROP PROCEDURE IF EXISTS `create_archive`$$
CREATE PROCEDURE `create_archive`(IN current_table VARCHAR(50))
BEGIN
DECLARE template,archive_template VARCHAR(50);
SET archive_template=REPLACE(CURDATE(),"-","");
SET template=CONCAT(current_table,"_",archive_template);

SET @archive_query:=CONCAT("CREATE TABLE ",template,
	" ENGINE=ARCHIVE AS (SELECT * FROM ",current_table," )");

PREPARE archive_query FROM @archive_query;
EXECUTE archive_query;
DEALLOCATE PREPARE archive_query;

END$$
</code></pre>
</section>

<section class="slide">
    <h2>Триггеры</h2>
    <pre style="font-size: 80%"><code class="sql">CREATE
    [DEFINER = { user | CURRENT_USER }]
    TRIGGER trigger_name trigger_time trigger_event
    ON tbl_name FOR EACH ROW trigger_body
 
trigger_time = BEFORE | AFTER
 
trigger_event = INSERT | UPDATE | DELETE
</code></pre>
</section>

<section class="slide">
    <h2>Триггеры: пример</h2>
    <pre style="font-size: 80%"><code class="sql">CREATE TRIGGER
	add_count_comment 
AFTER INSERT ON comments 
FOR EACH ROW BEGIN

UPDATE user
SET    user.countcomment = user.countcomment + 1 
WHERE  user.id = NEW.user_id; 
</code></pre>
</section>

<section class="slide">
    <h2>Триггеры: пример</h2>
    <pre style="font-size: 80%"><code class="sql">CASE NEW.owner_name
	WHEN 'Blog' THEN
		UPDATE blog 
		SET comment = comment + 1 
		WHERE id = NEW.owner_id;
	WHEN 'Article' THEN 
		UPDATE article 
		SET comment = comment + 1
		WHERE id = NEW.owner_id;
	WHEN 'PopulatePlace' THEN 
		UPDATE populate_place 
		SET comment = comment + 1 
		WHERE id = NEW.owner_id;
END CASE;
</code></pre>
</section>

<section class="slide">
    <h2>Триггеры: пример</h2>
    <pre style="font-size: 80%"><code class="sql">CASE NEW.owner_name
	WHEN 'Blog' THEN
		SET usertitle = (
			SELECT title FROM blog WHERE id=NEW.owner_id
		);
	WHEN 'Article' THEN 
		SET usertitle = (
			SELECT title FROM article WHERE id=NEW.owner_id
		);
	WHEN 'PopulatePlace' THEN
		SET usertitle = '';
END CASE;

INSERT INTO user_has_events
VALUES (NEW.user_id, NEW.id, "Comments", NOW() , usertitle);

END;
</code></pre>
</section>
